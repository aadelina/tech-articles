<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- 数据统计 -->
     <!--数据结构 {
            id: "44",
            sim_name: "BHS",
            name: "Bahamas",
            region: "Caribbean and Central America",
            resource: "Cereals",
            year: 2012,
            value: 427.395,
            weight: 969.33
        } 
    -->
    <!-- ● 统计要求：
        ○ 按 region 分组，计算出每一类 region 下 value 平均值、最大值、最小值、中位值、总和
        ○ 按 region 分组，计算每一年，每一类 region 下 value 平均值、最大值、最小值、中位值、总和
        ○ 按 resource 分类，计算每一类 resource 下 value 平均值、最大值、最小值、中位值、总和
        ○ 找到整个数据集中，weight 最大值、最小值、中位值
    -->

    <!-- Web 端实现：要求提供数据集统计页面，页面支持选择本地文件，之后根据文件内容启动计算流程，并在页面展示最终结果。 -->

    <!-- 文件上传区域 -->
    <input type="file" id="file-input" accept=".json" class="hidden">

    <!-- 数据预览区域 -->
    <section id="data-preview-section" class="mb-12 hidden">
        <div class="bg-white rounded-xl shadow-soft p-6">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-table text-primary mr-2"></i>数据预览
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="preview-header1"></tr>
                    </thead>
                    <tbody id="preview-body1" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="preview-header2"></tr>
                    </thead>
                    <tbody id="preview-body2" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="preview-header3"></tr>
                    </thead>
                    <tbody id="preview-body3" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="preview-header4"></tr>
                    </thead>
                    <tbody id="preview-body4" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </section>

    <script src="./web_handle_data.js"> </script>

    <script>

        //读取到的json 数据 
        let jsonData = null

        const fileInput = document.getElementById("file-input")
        const dataPreviewSection = document.getElementById('data-preview-section');
        const previewHeader1 = document.getElementById('preview-header1');
        const previewBody1 = document.getElementById('preview-body1');

        const previewHeader2 = document.getElementById('preview-header2');
        const previewBody2 = document.getElementById('preview-body2');

        const previewHeader3 = document.getElementById('preview-header3');
        const previewBody3 = document.getElementById('preview-body3');

        const previewHeader4 = document.getElementById('preview-header4');
        const previewBody4 = document.getElementById('preview-body4');

        fileInput.addEventListener("change",function(e) {

            const [file] = this.files

            if(file) {
                getJsonData(file)
            }

        })

        const getJsonData = function(file) {

            const reader = new FileReader()

            reader.onload = function(e) {
                try{
                    jsonData = JSON.parse(e.target.result)

                    const all_data = [...jsonData.nodes,...jsonData.edges]

                    const res_weight= static_data(all_data,"weight")

                    showDataPreview(res_weight,previewHeader4,previewBody4)

                    const res_region = static_classify_data(jsonData.nodes,"value","region")

                    showDataPreview(res_region,previewHeader1,previewBody1,"region")

                    const res_year = static_classify_data(jsonData.nodes,"value","year","region")

                    showDataPreview(res_year,previewHeader2,previewBody2,"year","region")

                    const res_resource = static_classify_data(jsonData.edges,"value","resource")

                    showDataPreview(res_resource,previewHeader3,previewBody3,"resource")

                    

                    // const all_data = [...jsonData.nodes,...jsonData.edges]

                    // const res = static_data(all_data,"weight")

                    console.log("res_year",res_resource)

                } catch(error){
                    console.log("error",error)
                }
            }

            reader.onerror = function(e) {
                console.log("❌读取文件错误")
            }

            reader.readAsText(file);
                    
        }

        // 显示数据预览
        function showDataPreview(data,previewHeader,previewBody,...addkey) {
            // 清空预览区域
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';

            
            // 获取所有唯一的属性作为表头

            const allProperties = new Set(["static_field","average","max","min","center","sum",...addkey]);
            
            // // 显示表头
            allProperties.forEach(prop => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider';
                th.textContent = prop.charAt(0).toUpperCase() + prop.slice(1);
                previewHeader.appendChild(th);
            });

            // 生成表格
            const get_table_tr = (value,index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-custom';

                Object.values(value).forEach(item => {
                    if(!Array.isArray(item)) {
                            const td = document.createElement('td');
                            td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                            td.textContent = item
                            tr.appendChild(td);
                            
                            previewBody.appendChild(tr);
                    }
                })
            }

            if(data instanceof Map) {
                data.forEach((value,key) => {
                    if(value instanceof Map){
                        for(let child_value of value.values()){

                            get_table_tr(child_value)
                        }
                    } else {
                            get_table_tr(value)
                    }
                })
            } else {
                get_table_tr(data)
            }

            // 显示预览区域
            dataPreviewSection.classList.remove('hidden');

        }

        // 显示结果
        function displayResults(results) {
            // 清空结果区域
            resultsBody.innerHTML = '';
            
            // 显示结果
            results.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-custom';
                
                // 区域
                const regionTd = document.createElement('td');
                regionTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-primary';
                regionTd.textContent = item.region;
                tr.appendChild(regionTd);
                
                // 平均值
                const avgTd = document.createElement('td');
                avgTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                avgTd.textContent = item.average;
                tr.appendChild(avgTd);
                
                // 最大值
                const maxTd = document.createElement('td');
                maxTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                maxTd.textContent = item.max;
                tr.appendChild(maxTd);
                
                // 最小值
                const minTd = document.createElement('td');
                minTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                minTd.textContent = item.min;
                tr.appendChild(minTd);
                
                // 中位值
                const medianTd = document.createElement('td');
                medianTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                medianTd.textContent = item.median;
                tr.appendChild(medianTd);
                
                // 总和
                const sumTd = document.createElement('td');
                sumTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                sumTd.textContent = item.sum
                tr.appendChild(sumTd);
                
                
                resultsBody.appendChild(tr);
            });
            
        }

    </script>
</body>
</html>